var p=(t=>(t.CALC="antetype.workspace.calc",t))(p||{}),y=(a=>(a.WEBP="image/webp",a.PNG="image/png",a.JPG="image/jpeg",a))(y||{});var h=(e=>(e.CALC="antetype.cursor.calc",e.POSITION="antetype.cursor.position",e.DOWN="antetype.cursor.on.down",e.UP="antetype.cursor.on.up",e.MOVE="antetype.cursor.on.move",e.SLIP="antetype.cursor.on.slip",e.RESIZED="antetype.cursor.on.resized",e))(h||{});var m={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},C="core",S="0.0.5",W=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#i()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[C]={load:async()=>(this.#t??=(await this.#a("core.js")).default,(r,a)=>this.#t({canvas:a,modules:r,herald:this.#e.herald})),version:S}}static subscriptions={[m.MODULES]:"register"};#a(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#i(){return this.#r??=(await this.#a("helper.js")).default,new this.#r(this.#e.herald)}},x=(e=>(e.SAVE="antetype.memento.save",e))(x||{}),g={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},I="core",T="0.0.5",A=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e,t){return(await this.#i()).loadModules(e,t)}register(e){let{registration:t}=e.detail;t[I]={load:async()=>(this.#t??=(await this.#a("core.js")).default,(r,a)=>this.#t({canvas:a,modules:r,herald:this.#e.herald})),version:T}}static subscriptions={[g.MODULES]:"register"};#a(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#i(){return this.#r??=(await this.#a("helper.js")).default,new this.#r(this.#e.herald)}},D="memento",z="0.0.4",R=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:t}=e.detail;t[D]={load:async()=>{if(!this.#t){let r=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(r)).default}return(r,a)=>this.#t({canvas:a,modules:r,herald:this.#e.herald})},version:z}}static subscriptions={[g.MODULES]:"register"}};var O="cursor",N="0.0.5",j=class{#e;#t=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}register(e){let{registration:t}=e.detail;t[O]={load:async()=>{if(!this.#t){let r=this.#e.marshal.getResourceUrl(this,"module.js");this.#t=(await import(r)).default}return(r,a)=>this.#t({canvas:a,modules:r,herald:this.#e.herald})},version:N}}static subscriptions={[m.MODULES]:"register"}};var o={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded",CANVAS_CHANGE:"antetype.canvas.change"};var k="core",M="0.0.5",K=class{#e;#t=null;#r=null;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(e){this.#e=e}async loadModules(e){return(await this.#i()).loadModules(e)}register(e){let{registration:t}=e.detail;t[k]={load:async()=>(this.#t??=(await this.#a("core.js")).default,r=>this.#t({modules:r,herald:this.#e.herald})),version:M}}static subscriptions={[o.MODULES]:"register"};#a(e){return import(this.#e.marshal.getResourceUrl(this,e))}async#i(){return this.#r??=(await this.#a("helper.js")).default,new this.#r(this.#e.herald)}};var u=class{#modules;#herald;#translationSet=0;#drawWorkspace=!0;#isExporting=!1;#quality=1;#scale=1;#observer;#translate={left:0,top:0};constructor(e,t){this.#modules=e,this.#herald=t,this.#observer=new ResizeObserver(()=>{!this.#updateCanvas()||!this.#modules.core||this.#modules.core.view.recalculate().then(()=>{this.#modules.core.view.redraw()})}),this.subscribe()}subscribe(){let e=this.#herald.batch([{event:o.CLOSE,subscription:()=>{e()}},{event:o.CANVAS_CHANGE,subscription:({detail:{previous:t,current:r}})=>{t instanceof HTMLCanvasElement&&this.#observer.unobserve(t),r instanceof HTMLCanvasElement&&(r.width=r.offsetWidth,r.height=r.offsetHeight,this.#observer.observe(r),this.#updateCanvas(r))}},{event:"antetype.workspace.calc",subscription:this.calcEventHandle.bind(this)},{event:o.DRAW,subscription:[{method:t=>{let{element:r}=t.detail,i={clear:this.clearCanvas.bind(this),workspace:this.drawWorkspace.bind(this)}[r.type];typeof i=="function"&&i(r)},priority:1},{method:()=>{this.setOrigin()},priority:-255},{method:()=>{this.restore()},priority:255}]},{event:h.POSITION,subscription:t=>{t.detail.x-=this.getLeft(),t.detail.y-=this.getTop()}},{event:h.CALC,subscription:this.calcEventHandle.bind(this)},{event:o.SETTINGS,subscription:t=>{t.detail.settings.push(this.getSettingsDefinition())}},{event:"antetype.conditions.method.register",subscription:t=>{this.handleConditionsMethodRegisterMethod(t)}}])}calcEventHandle(e){let t=e.detail.values,r=Object.keys(t);for(let a of r)t[a]=this.calc(t[a])}#ctx(){let e=this.#modules.core.meta.getCanvas();if(!e)throw new Error("[Antetype Workspace] Provided canvas is empty");return e.getContext("2d")}#updateCanvas(e){e??=this.#ctx().canvas;let t=e.width,r=e.height;e instanceof HTMLCanvasElement&&(t=e.offsetWidth,r=e.offsetHeight);let a=t*this.#quality,i=r*this.#quality;return!i||!a||a===e.width&&i===e.height?!1:(e.height=i,e.width=a,!0)}setTranslateLeft(e){this.#translate.left=e}setTranslateTop(e){this.#translate.top=e}getTranslate(){return this.#translate}setQuality(e){if(isNaN(e))throw new Error("Workspace quality must be a number");this.#quality=Number(e),this.#updateCanvas()}getQuality(){return this.#quality}getScale(){return this.#scale}setScale(e){if(isNaN(e))throw new Error("Workspace scale must be a number");this.#scale=e}scale(e){return e*this.#scale*this.#quality}typeToExt(e){return e=="image/png".toString()?"png":e=="image/jpeg".toString()?"jpg":"webp"}async download(e){let t=document.createElement("a");t.download=e.filename+"."+this.typeToExt(e.type);let r=URL.createObjectURL(await this.export(e));t.href=r,t.click(),URL.revokeObjectURL(r)}#updateQualityBasedOnDpi(e){let a=e*11.692913385826772,i=this.getSize().height/this.#quality;this.setQuality(a/i)}async export({type:e="image/webp",quality:t=.9,dpi:r=300}={}){let a=this.#modules.core.view,i=this.#drawWorkspace;try{this.#drawWorkspace=!1,this.setExporting(!0),this.#updateQualityBasedOnDpi(r),this.#updateCanvas(),await a.recalculate(),a.redraw();let n=await this.#canvasToBlob(e,t);if(!n)throw new Error("Couldn't export canvas workspace");return n}finally{this.#drawWorkspace=i,this.setExporting(!1),this.setQuality(1),this.#updateCanvas(),await a.recalculate(),a.redraw()}}#canvasToBlob(e="image/webp",t=.9){let{width:r,height:a}=this.getSize(),i=this.getTop(),n=this.getLeft(),s=this.#ctx().getImageData(n,i,r,a),l=document.createElement("canvas");return l.width=r,l.height=a,l.getContext("2d").putImageData(s,0,0),new Promise(d=>{let b=setTimeout(()=>{d(null)},3e4);l.toBlob(E=>{clearTimeout(b),d(E)},e,t)})}clearCanvas(){let e=this.#ctx();e.clearRect(-this.getLeft(),-this.getTop(),e.canvas.width,e.canvas.height)}setExporting(e){this.#isExporting=e}isExporting(){return this.#isExporting}drawWorkspace(){if(this.#isExporting)return;let e=this.#ctx();e.save();let{height:t,width:r}=this.getSize();e.fillStyle="#FFF",e.fillRect(0,0,r,t),e.restore()}getLeft(){let e=this.#ctx(),{width:t}=this.getSize();return(Number(e.canvas.width)-t)/2+this.getTranslate().left}getTop(){let e=this.#ctx(),{height:t}=this.getSize();return(Number(e.canvas.height)-t)/2+this.getTranslate().top}setOrigin(){if(this.#translationSet++,this.#translationSet>1)return;let e=this.#ctx();e.save(),e.translate(this.getLeft(),this.getTop())}restore(){this.#translationSet--,this.#translationSet==0&&this.#ctx().restore()}toRelative(e,t="x",r=3){let{height:a,width:i}=this.#getSizeRelative();e=Math.round((e+Number.EPSILON)*10**r)/10**r;let n=e/a*100,s="h%";return t==="x"&&(n=e/i*100,s="w%"),String(Math.round((n+Number.EPSILON)*10**r)/10**r)+s}calc(operation,quiet=!1){if(typeof operation=="number")return this.scale(operation);if(typeof operation!="string"||operation.match(/[^-()\d/*+.pxw%hv ]/g))return console.warn("Calculation contains invalid characters!",operation),NaN;let convertUnitToNumber=(e,t=2)=>Number(e.slice(0,e.length-t)),{height:aHeight,width:aWidth}=this.getSize(),{height,width}=this.#getSizeRelative(),unitsTranslator={px:e=>convertUnitToNumber(e),"w%":e=>convertUnitToNumber(e)/100*width,"h%":e=>convertUnitToNumber(e)/100*height,vh:e=>convertUnitToNumber(e)/100*aHeight,vw:e=>convertUnitToNumber(e)/100*aWidth,default:e=>e},calculation="";operation.split(" ").forEach(e=>{e=e.trim();let t=e[e.length-1],r=e[e.length-2],a=(unitsTranslator[r+t]||unitsTranslator.default)(e);typeof a=="number"&&(a=this.#decimal(a)),calculation+=String(a)});let result;try{result=eval(calculation)}catch(e){result=void 0,quiet||console.warn("Invalid calculation! Tried to calculate from",calculation)}return result==null?NaN:this.#decimal(result)}#decimal(e,t=2){return+e.toFixed(t)}#getSystem(){return this.#modules.core}#getCanvasCurrentSizes(){let e=this.#ctx().canvas;return{height:e instanceof HTMLCanvasElement?e.offsetHeight:e.height,width:e instanceof HTMLCanvasElement?e.offsetWidth:e.width}}#getSettings(){let{height:e}=this.#getCanvasCurrentSizes(),t=this.#getSystem().setting.get("workspace")??{};if(isNaN(Number(t.height))&&(t.height=e),isNaN(Number(t.width))){let r=.707070707;t.width=Math.round(e*r)}return t}getSize(){let{width:e,height:t}=this.#getSettings(),r=e/t,{height:a,width:i}=this.#getCanvasCurrentSizes(),n=a*r;return n>i&&(n=i,a=n/r),{width:this.scale(n),height:this.scale(a)}}#getSizeRelative(){let e=this.#getSettings(),{width:t,height:r}=this.getSize(),a=e.relative?.width??t,i=e.relative?.height??r,n=a/i,s={width:e.relative?.width??0,height:e.relative?.height??0},{height:l,width:c}=this.#getCanvasCurrentSizes();return s.width||(s.width=this.scale(l*n)),s.height||(s.height=this.scale(l)),s.width>this.scale(c)&&(s.width=this.scale(c),s.height=this.scale(c/n)),{width:s.width,height:s.height}}handleConditionsMethodRegisterMethod(e){let{methods:t}=e.detail;t.hideOnExport={name:"Hide on export",type:"hide-export",resolve:({event:r})=>{this.isExporting()&&(r.detail.element={type:"none",start:{x:0,y:0},size:{w:0,h:0}})}}}getSettingsDefinition(){let e=this.#getSettings();return{details:{label:"Workspace"},name:"workspace",tabs:[{label:"General",fields:[[{label:"Dimensions",type:"container",fields:[[{label:"Height",type:"number",name:"height",value:e.height},{label:"Width",type:"number",name:"width",value:e.width}]]}]]}]}}};var v="workspace",w="0.0.4",f=class{#e=null;#t;static inject={marshal:"boardmeister/marshal",herald:"boardmeister/herald"};inject(t){this.#t=t}register(t){let{registration:r}=t.detail;r[v]={load:async()=>{if(!this.#e){let a=this.#t.marshal.getResourceUrl(this,"module.js");this.#e=(await import(a)).default}return a=>new this.#e(a,this.#t.herald)},version:w}}static subscriptions={[o.MODULES]:"register"}};export{y as BlobTypes,p as Event,v as ID,w as VERSION,u as Workspace};
