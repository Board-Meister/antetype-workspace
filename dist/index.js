var d=(t=>(t.CALC="antetype.workspace.calc",t))(d||{}),p=(a=>(a.WEBP="image/webp",a.PNG="image/png",a.JPG="image/jpeg",a))(p||{});var l=(e=>(e.CALC="antetype.cursor.calc",e.POSITION="antetype.cursor.position",e.DOWN="antetype.cursor.on.down",e.UP="antetype.cursor.on.up",e.MOVE="antetype.cursor.on.move",e.SLIP="antetype.cursor.on.slip",e.RESIZED="antetype.cursor.on.resized",e))(l||{});var y={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},b=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async#r(e,t){let r=this.#e.minstrel.getResourceUrl(this,"core.js");return this.#t=(await import(r)).default,this.#t({canvas:t,modules:e,herald:this.#e.herald})}async register(e){let{modules:t,canvas:r}=e.detail;t.core=await this.#r(t,r)}static subscriptions={[y.MODULES]:"register"}},f=(e=>(e.SAVE="antetype.memento.save",e))(f||{}),E=class{#e;#t=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async register(e){let{modules:t,canvas:r}=e.detail;if(!this.#t){let a=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(a)).default}t.memento=this.#t({canvas:r,modules:t,herald:this.#e.herald})}static subscriptions={[y.MODULES]:"register"}};var c={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"};var u=class{#canvas;#modules;#herald;#ctx;#translationSet=0;#drawWorkspace=!0;#isExporting=!1;#quality=1;#scale=1;#translate={left:0,top:0};constructor(e,t,r){if(!e)throw new Error("[Antetype Workspace] Provided canvas is empty");this.#canvas=e,this.#updateCanvas(),this.#modules=t,this.#ctx=this.#canvas.getContext("2d"),this.#observeCanvasResize(),this.#herald=r,this.subscribe()}subscribe(){let e=this.#herald.batch([{event:c.CLOSE,subscription:()=>{e()}},{event:"antetype.workspace.calc",subscription:this.calcEventHandle.bind(this)},{event:c.DRAW,subscription:[{method:t=>{let{element:r}=t.detail,i={clear:this.clearCanvas.bind(this),workspace:this.drawWorkspace.bind(this)}[r.type];typeof i=="function"&&i(r)},priority:1},{method:()=>{this.setOrigin()},priority:-255},{method:()=>{this.restore()},priority:255}]},{event:l.POSITION,subscription:t=>{t.detail.x-=this.getLeft(),t.detail.y-=this.getTop()}},{event:l.CALC,subscription:this.calcEventHandle.bind(this)},{event:c.SETTINGS,subscription:t=>{t.detail.settings.push(this.getSettingsDefinition())}},{event:"antetype.conditions.method.register",subscription:t=>{this.handleConditionsMethodRegisterMethod(t)}}])}calcEventHandle(e){let t=e.detail.values,r=Object.keys(t);for(let a of r)t[a]=this.calc(t[a])}#observeCanvasResize(){new ResizeObserver(()=>{!this.#updateCanvas()||!this.#modules.core||this.#modules.core.view.recalculate().then(()=>{this.#modules.core.view.redraw()})}).observe(this.#canvas)}#updateCanvas(){let e=this.#canvas.offsetWidth*this.#quality,t=this.#canvas.offsetHeight*this.#quality,r=Number(this.#canvas.getAttribute("width")),a=Number(this.#canvas.getAttribute("height"));return!t||!e||r===e&&a===t?!1:(this.#canvas.setAttribute("height",String(t)),this.#canvas.setAttribute("width",String(e)),!0)}setTranslateLeft(e){this.#translate.left=e}setTranslateTop(e){this.#translate.top=e}getTranslate(){return this.#translate}setQuality(e){if(isNaN(e))throw new Error("Workspace quality must be a number");this.#quality=Number(e),this.#updateCanvas()}getQuality(){return this.#quality}getScale(){return this.#scale}setScale(e){if(isNaN(e))throw new Error("Workspace scale must be a number");this.#scale=e}scale(e){return e*this.#scale*this.#quality}typeToExt(e){return e=="image/png".toString()?"png":e=="image/jpeg".toString()?"jpg":"webp"}async download(e){let t=document.createElement("a");t.download=e.filename+"."+this.typeToExt(e.type);let r=URL.createObjectURL(await this.export(e));t.href=r,t.click(),URL.revokeObjectURL(r)}#updateQualityBasedOnDpi(e){let a=e*11.692913385826772,i=this.getSize().height/this.#quality;this.setQuality(a/i)}async export({type:e="image/webp",quality:t=.9,dpi:r=300}={}){let a=this.#modules.core.view,i=this.#drawWorkspace;try{this.#drawWorkspace=!1,this.setExporting(!0),this.#updateQualityBasedOnDpi(r),this.#updateCanvas(),await a.recalculate(),a.redraw();let s=await this.#canvasToBlob(e,t);if(!s)throw new Error("Couldn't export canvas workspace");return s}finally{this.#drawWorkspace=i,this.setExporting(!1),this.setQuality(1),this.#updateCanvas(),await a.recalculate(),a.redraw()}}#canvasToBlob(e="image/webp",t=.9){let{width:r,height:a}=this.getSize(),i=this.getTop(),s=this.getLeft(),n=this.#ctx.getImageData(s,i,r,a),o=document.createElement("canvas");return o.width=r,o.height=a,o.getContext("2d").putImageData(n,0,0),new Promise(h=>{let g=setTimeout(()=>{h(null)},3e4);o.toBlob(m=>{clearTimeout(g),h(m)},e,t)})}clearCanvas(){this.#ctx.clearRect(-this.getLeft(),-this.getTop(),this.#canvas.width,this.#canvas.height)}setExporting(e){this.#isExporting=e}isExporting(){return this.#isExporting}drawWorkspace(){if(this.#isExporting)return;let e=this.#ctx;e.save();let{height:t,width:r}=this.getSize();e.fillStyle="#FFF",e.fillRect(0,0,r,t),e.restore()}getLeft(){let e=this.#ctx,{width:t}=this.getSize();return(Number(e.canvas.getAttribute("width"))-t)/2+this.getTranslate().left}getTop(){let e=this.#ctx,{height:t}=this.getSize();return(Number(e.canvas.getAttribute("height"))-t)/2+this.getTranslate().top}setOrigin(){if(this.#translationSet++,this.#translationSet>1)return;let e=this.#ctx;e.save(),e.translate(this.getLeft(),this.getTop())}restore(){this.#translationSet--,this.#translationSet==0&&this.#ctx.restore()}toRelative(e,t="x",r=3){let{height:a,width:i}=this.#getSizeRelative();e=Math.round((e+Number.EPSILON)*10**r)/10**r;let s=e/a*100,n="h%";return t==="x"&&(s=e/i*100,n="w%"),String(Math.round((s+Number.EPSILON)*10**r)/10**r)+n}calc(operation,quiet=!1){if(typeof operation=="number")return this.scale(operation);if(typeof operation!="string"||operation.match(/[^-()\d/*+.pxw%hv ]/g))return console.warn("Calculation contains invalid characters!",operation),NaN;let convertUnitToNumber=(e,t=2)=>Number(e.slice(0,e.length-t)),{height:aHeight,width:aWidth}=this.getSize(),{height,width}=this.#getSizeRelative(),unitsTranslator={px:e=>convertUnitToNumber(e),"w%":e=>convertUnitToNumber(e)/100*width,"h%":e=>convertUnitToNumber(e)/100*height,vh:e=>convertUnitToNumber(e)/100*aHeight,vw:e=>convertUnitToNumber(e)/100*aWidth,default:e=>e},calculation="";operation.split(" ").forEach(e=>{e=e.trim();let t=e[e.length-1],r=e[e.length-2],a=(unitsTranslator[r+t]||unitsTranslator.default)(e);typeof a=="number"&&(a=this.#decimal(a)),calculation+=String(a)});let result;try{result=eval(calculation)}catch(e){result=void 0,quiet||console.warn("Invalid calculation! Tried to calculate from",calculation)}return result==null?NaN:this.#decimal(result)}#decimal(e,t=2){return+e.toFixed(t)}#getSystem(){return this.#modules.core}#getSettings(){let e=this.#ctx.canvas.offsetHeight,t=this.#getSystem().setting.get("workspace")??{};if(isNaN(Number(t.height))&&(t.height=e),isNaN(Number(t.width))){let r=.707070707;t.width=Math.round(e*r)}return t}getSize(){let{width:e,height:t}=this.#getSettings(),r=e/t,a=this.#ctx.canvas.offsetHeight,i=a*r;return i>this.#ctx.canvas.offsetWidth&&(i=this.#ctx.canvas.offsetWidth,a=i/r),{width:this.scale(i),height:this.scale(a)}}#getSizeRelative(){let e=this.#getSettings(),{width:t,height:r}=this.getSize(),a=e.relative?.width??t,i=e.relative?.height??r,s=a/i,n={width:e.relative?.width??0,height:e.relative?.height??0},o=this.#ctx.canvas.offsetHeight;return n.width||(n.width=this.scale(o*s)),n.height||(n.height=this.scale(o)),n.width>this.scale(this.#ctx.canvas.offsetWidth)&&(n.width=this.scale(this.#ctx.canvas.offsetWidth),n.height=this.scale(this.#ctx.canvas.offsetWidth/s)),{width:n.width,height:n.height}}handleConditionsMethodRegisterMethod(e){let{methods:t}=e.detail;t.hideOnExport={name:"Hide on export",type:"hide-export",resolve:({event:r})=>{this.isExporting()&&(r.detail.element=null)}}}getSettingsDefinition(){let e=this.#getSettings();return{details:{label:"Workspace"},name:"workspace",tabs:[{label:"General",fields:[[{label:"Dimensions",type:"container",fields:[[{label:"Height",type:"number",name:"height",value:e.height},{label:"Width",type:"number",name:"width",value:e.width}]]}]]}]}}};export{p as BlobTypes,d as Event,u as Workspace};
