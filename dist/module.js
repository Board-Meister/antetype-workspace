var u={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},f=class{#t;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(t){this.#t=t}async#i(t,e){let i=this.#t.minstrel.getResourceUrl(this,"core.js");return this.#e=(await import(i)).default,this.#e({canvas:e,modules:t,herald:this.#t.herald})}async register(t){let{modules:e,canvas:i}=t.detail;e.core=await this.#i(e,i)}static subscriptions={[u.MODULES]:"register"}},c=(t=>(t.CALC="antetype.cursor.calc",t.POSITION="antetype.cursor.position",t.DOWN="antetype.cursor.on.down",t.UP="antetype.cursor.on.up",t.MOVE="antetype.cursor.on.move",t.SLIP="antetype.cursor.on.slip",t.RESIZED="antetype.cursor.on.resized",t))(c||{}),y=class{#t;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(t){this.#t=t}async register(t){let{modules:e,canvas:i}=t.detail;if(!this.#e){let s=this.#t.minstrel.getResourceUrl(this,"module.js");this.#e=(await import(s)).default}e.cursor=this.#e({canvas:i,modules:e,herald:this.#t.herald})}static subscriptions={[u.MODULES]:"register"}};var l={INIT:"antetype.init",CLOSE:"antetype.close",DRAW:"antetype.draw",CALC:"antetype.calc",RECALC_FINISHED:"antetype.recalc.finished",MODULES:"antetype.modules",SETTINGS:"antetype.settings.definition",TYPE_DEFINITION:"antetype.layer.type.definition",FONTS_LOADED:"antetype.font.loaded"},I=class{#t;#e=null;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(t){this.#t=t}async#i(t,e){let i=this.#t.minstrel.getResourceUrl(this,"core.js");return this.#e=(await import(i)).default,this.#e({canvas:e,modules:t,herald:this.#t.herald})}async register(t){let{modules:e,canvas:i}=t.detail;e.core=await this.#i(e,i)}static subscriptions={[l.MODULES]:"register"}};var p=class{#t=null;#e;static inject={minstrel:"boardmeister/minstrel",herald:"boardmeister/herald"};inject(e){this.#e=e}async register(e){let{modules:i,canvas:s}=e.detail;if(!this.#t){let r=this.#e.minstrel.getResourceUrl(this,"module.js");this.#t=(await import(r)).default}i.workspace=new this.#t(s,i,this.#e.herald)}static subscriptions={[l.MODULES]:"register"}};var v=(s=>(s.WEBP="image/webp",s.PNG="image/png",s.JPG="image/jpeg",s))(v||{}),h=class{#canvas;#modules;#herald;#ctx;#translationSet=0;#drawWorkspace=!0;#isExporting=!1;#quality=1;#scale=1;#translate={left:0,top:0};constructor(t,e,i){if(!t)throw new Error("[Antetype Workspace] Provided canvas is empty");this.#canvas=t,this.#updateCanvas(),this.#modules=e,this.#ctx=this.#canvas.getContext("2d"),this.#observeCanvasResize(),this.#herald=i,this.subscribe()}subscribe(){let t=this.#herald.batch([{event:l.CLOSE,subscription:()=>{t()}},{event:"antetype.workspace.calc",subscription:this.calcEventHandle.bind(this)},{event:l.DRAW,subscription:[{method:e=>{let{element:i}=e.detail,r={clear:this.clearCanvas.bind(this),workspace:this.drawWorkspace.bind(this)}[i.type];typeof r=="function"&&r(i)},priority:1},{method:()=>{this.setOrigin()},priority:-255},{method:()=>{this.restore()},priority:255}]},{event:c.POSITION,subscription:e=>{e.detail.x-=this.getLeft(),e.detail.y-=this.getTop()}},{event:c.CALC,subscription:this.calcEventHandle.bind(this)},{event:l.SETTINGS,subscription:e=>{e.detail.settings.push(this.getSettingsDefinition())}},{event:"antetype.conditions.method.register",subscription:e=>{this.handleConditionsMethodRegisterMethod(e)}}])}calcEventHandle(t){let e=t.detail.values,i=Object.keys(e);for(let s of i)e[s]=this.calc(e[s])}#observeCanvasResize(){new ResizeObserver(()=>{!this.#updateCanvas()||!this.#modules.core||this.#modules.core.view.recalculate().then(()=>{this.#modules.core.view.redraw()})}).observe(this.#canvas)}#updateCanvas(){let t=this.#canvas.offsetWidth*this.#quality,e=this.#canvas.offsetHeight*this.#quality,i=Number(this.#canvas.getAttribute("width")),s=Number(this.#canvas.getAttribute("height"));return!e||!t||i===t&&s===e?!1:(this.#canvas.setAttribute("height",String(e)),this.#canvas.setAttribute("width",String(t)),!0)}setTranslateLeft(t){this.#translate.left=t}setTranslateTop(t){this.#translate.top=t}getTranslate(){return this.#translate}setQuality(t){if(isNaN(t))throw new Error("Workspace quality must be a number");this.#quality=Number(t),this.#updateCanvas()}getQuality(){return this.#quality}getScale(){return this.#scale}setScale(t){if(isNaN(t))throw new Error("Workspace scale must be a number");this.#scale=t}scale(t){return t*this.#scale*this.#quality}typeToExt(t){return t=="image/png".toString()?"png":t=="image/jpeg".toString()?"jpg":"webp"}async download(t){let e=document.createElement("a");e.download=t.filename+"."+this.typeToExt(t.type);let i=URL.createObjectURL(await this.export(t));e.href=i,e.click(),URL.revokeObjectURL(i)}#updateQualityBasedOnDpi(t){let s=t*11.692913385826772,r=this.getSize().height/this.#quality;this.setQuality(s/r)}async export({type:t="image/webp",quality:e=.9,dpi:i=300}={}){let s=this.#modules.core.view,r=this.#drawWorkspace;try{this.#drawWorkspace=!1,this.setExporting(!0),this.#updateQualityBasedOnDpi(i),this.#updateCanvas(),await s.recalculate(),s.redraw();let a=await this.#canvasToBlob(t,e);if(!a)throw new Error("Couldn't export canvas workspace");return a}finally{this.#drawWorkspace=r,this.setExporting(!1),this.setQuality(1),this.#updateCanvas(),await s.recalculate(),s.redraw()}}#canvasToBlob(t="image/webp",e=.9){let{width:i,height:s}=this.getSize(),r=this.getTop(),a=this.getLeft(),n=this.#ctx.getImageData(a,r,i,s),o=document.createElement("canvas");return o.width=i,o.height=s,o.getContext("2d").putImageData(n,0,0),new Promise(d=>{let g=setTimeout(()=>{d(null)},3e4);o.toBlob(m=>{clearTimeout(g),d(m)},t,e)})}clearCanvas(){this.#ctx.clearRect(-this.getLeft(),-this.getTop(),this.#canvas.width,this.#canvas.height)}setExporting(t){this.#isExporting=t}isExporting(){return this.#isExporting}drawWorkspace(){if(this.#isExporting)return;let t=this.#ctx;t.save();let{height:e,width:i}=this.getSize();t.fillStyle="#FFF",t.fillRect(0,0,i,e),t.restore()}getLeft(){let t=this.#ctx,{width:e}=this.getSize();return(Number(t.canvas.getAttribute("width"))-e)/2+this.getTranslate().left}getTop(){let t=this.#ctx,{height:e}=this.getSize();return(Number(t.canvas.getAttribute("height"))-e)/2+this.getTranslate().top}setOrigin(){if(this.#translationSet++,this.#translationSet>1)return;let t=this.#ctx;t.save(),t.translate(this.getLeft(),this.getTop())}restore(){this.#translationSet--,this.#translationSet==0&&this.#ctx.restore()}toRelative(t,e="x",i=3){let{height:s,width:r}=this.#getSizeRelative();t=Math.round((t+Number.EPSILON)*10**i)/10**i;let a=t/s*100,n="h%";return e==="x"&&(a=t/r*100,n="w%"),String(Math.round((a+Number.EPSILON)*10**i)/10**i)+n}calc(operation,quiet=!1){if(typeof operation=="number")return this.scale(operation);if(typeof operation!="string"||operation.match(/[^-()\d/*+.pxw%hv ]/g))return console.warn("Calculation contains invalid characters!",operation),NaN;let convertUnitToNumber=(t,e=2)=>Number(t.slice(0,t.length-e)),{height:aHeight,width:aWidth}=this.getSize(),{height,width}=this.#getSizeRelative(),unitsTranslator={px:t=>convertUnitToNumber(t),"w%":t=>convertUnitToNumber(t)/100*width,"h%":t=>convertUnitToNumber(t)/100*height,vh:t=>convertUnitToNumber(t)/100*aHeight,vw:t=>convertUnitToNumber(t)/100*aWidth,default:t=>t},calculation="";operation.split(" ").forEach(t=>{t=t.trim();let e=t[t.length-1],i=t[t.length-2],s=(unitsTranslator[i+e]||unitsTranslator.default)(t);typeof s=="number"&&(s=this.#decimal(s)),calculation+=String(s)});let result;try{result=eval(calculation)}catch(t){result=void 0,quiet||console.warn("Invalid calculation! Tried to calculate from",calculation)}return result==null?NaN:this.#decimal(result)}#decimal(t,e=2){return+t.toFixed(e)}#getSystem(){return this.#modules.core}#getSettings(){let t=this.#ctx.canvas.offsetHeight,e=this.#getSystem().setting.get("workspace")??{};if(isNaN(Number(e.height))&&(e.height=t),isNaN(Number(e.width))){let i=.707070707;e.width=Math.round(t*i)}return e}getSize(){let{width:t,height:e}=this.#getSettings(),i=t/e,s=this.#ctx.canvas.offsetHeight,r=s*i;return r>this.#ctx.canvas.offsetWidth&&(r=this.#ctx.canvas.offsetWidth,s=r/i),{width:this.scale(r),height:this.scale(s)}}#getSizeRelative(){let t=this.#getSettings(),{width:e,height:i}=this.getSize(),s=t.relative?.width??e,r=t.relative?.height??i,a=s/r,n={width:t.relative?.width??0,height:t.relative?.height??0},o=this.#ctx.canvas.offsetHeight;return n.width||(n.width=this.scale(o*a)),n.height||(n.height=this.scale(o)),n.width>this.scale(this.#ctx.canvas.offsetWidth)&&(n.width=this.scale(this.#ctx.canvas.offsetWidth),n.height=this.scale(this.#ctx.canvas.offsetWidth/a)),{width:n.width,height:n.height}}handleConditionsMethodRegisterMethod(t){let{methods:e}=t.detail;e.hideOnExport={name:"Hide on export",type:"hide-export",resolve:({event:i})=>{this.isExporting()&&(i.detail.element=null)}}}getSettingsDefinition(){let t=this.#getSettings();return{details:{label:"Workspace"},name:"workspace",tabs:[{label:"General",fields:[[{label:"Dimensions",type:"container",fields:[[{label:"Height",type:"number",name:"height",value:t.height},{label:"Width",type:"number",name:"width",value:t.width}]]}]]}]}}};export{v as BlobTypes,h as default};
